#!/usr/bin/env node

var fs = require('fs');
var iterateOnFile = require('./iterator.js').iterateOnFile;

var query = JSON.parse(process.argv[3]);
var queryKeys = Object.keys(query);

var updates = JSON.parse(process.argv[4]);
var updatesKeys = Object.keys(updates);

var tempFile = fs.createWriteStream(process.argv[2] + '.temp');
var recordsUpdated = 0;

var updateTempFile = function updateTempFile (record) {
    var recordMatched = true;

    for( j=0; j < queryKeys.length; j++ ){
        if (typeof(query[queryKeys[j]]) === 'string') {
            recordMatched &= (query[queryKeys[j]] == record[queryKeys[j]])
        } else if (query[queryKeys[j]]['$ne']) {
            recordMatched &= (query[queryKeys[j]]['$ne'] != record[queryKeys[j]])
        }
    }

    if ( recordMatched ) {
        updatesKeys.forEach( function (key) {
            if (typeof(updates[key]) === 'string') {
                record[key] = updates[key];
            } else if (updates[key]['$function']) {
                record[key] = eval(updates[key]['$function'])(record);
            }
        });
        recordsUpdated += 1;
    }

    tempFile.write(JSON.stringify(record) + '\n');
};

var writeChanges = function writeChanges () {
    tempFile.end();
    fs.rename(process.argv[2] + '.temp', process.argv[2], function () {
        process.stdout.write('Updated ' + recordsUpdated + ' records.');
    });
};

iterateOnFile( updateTempFile, writeChanges );
